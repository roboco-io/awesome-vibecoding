name: Issue Approval Handler

on:
  issue_comment:
    types: [created]

jobs:
  check-approval:
    # Only run when:
    # 1. Comment is on an issue (not a PR)
    # 2. Commenter is the repository owner
    # 3. Comment contains approval keyword
    if: |
      github.event.issue.pull_request == null &&
      github.event.comment.user.login == 'serithemage' &&
      contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Acknowledge approval
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ Approval received! Processing the resource addition...'
            });

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Process Issue and Update README
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          PROMPT=$(cat .github/prompts/issue-approval.md)

          claude -p "
          $PROMPT

          ## Issue Details

          **Issue #$ISSUE_NUMBER**: $ISSUE_TITLE

          **Issue Body**:
          $ISSUE_BODY

          Process this issue and add the resource to README.md, then translate to Korean and Japanese.
          " --allowedTools "Edit,Read,Glob,Grep,Write,Bash(git status)" \
            --max-turns 30

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Add resource from issue #${{ github.event.issue.number }}"
          title: "[Auto] Add resource from issue #${{ github.event.issue.number }}"
          body: |
            ## Resource Addition from Issue

            This PR was automatically generated to add a resource suggested in issue #${{ github.event.issue.number }}.

            ### Source Issue
            - **Title**: ${{ github.event.issue.title }}
            - **Link**: #${{ github.event.issue.number }}
            - **Approved by**: @${{ github.event.comment.user.login }}

            ### Changes
            - Added new resource to README.md
            - Synchronized translations (Korean, Japanese)

            ### Review Checklist
            - [ ] Resource URL is valid
            - [ ] Description is accurate
            - [ ] Placed in correct category
            - [ ] Translations are correct

            ---
            *Generated by [Claude Code](https://claude.ai/code) via GitHub Actions*

            Closes #${{ github.event.issue.number }}
          branch: auto-add/issue-${{ github.event.issue.number }}
          delete-branch: true
          labels: |
            automated
            documentation

      - name: Comment on Issue
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üéâ Pull request created: #${{ steps.create-pr.outputs.pull-request-number }}\n\nThe resource has been added and translations are ready for review.`
            });

      - name: Comment on failure (no changes)
        if: steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ö†Ô∏è No changes were made. The resource may already exist or the issue format was not recognized. Please check the issue content and try again.'
            });
